<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Misioneros y Can√≠bales - Visual</title>
    <link href="/static/styles.css" rel="stylesheet">
    <script>
        let secondsElapsed = 0;
        let timerInterval = null;
        const safePath = {{ nodes | tojson }};

        function startTimer() {
            secondsElapsed = 0;
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                secondsElapsed++;
                updateTimerDisplay();
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function updateTimerDisplay() {
            const mins = String(Math.floor(secondsElapsed / 60)).padStart(2, '0');
            const secs = String(secondsElapsed % 60).padStart(2, '0');
            document.getElementById("timer").textContent = `‚è±Ô∏è Tiempo: ${mins}:${secs}`;
        }

        let state = {
            left: { m: 3, c: 3 },
            right: { m: 0, c: 0 },
            boat: { m: 0, c: 0 },
            boatSide: 'left'
        };

        function render() {
            const left = document.getElementById("left");
            const right = document.getElementById("right");
            const boat = document.getElementById("boat");

            left.innerHTML = "";
            right.innerHTML = "";
            boat.innerHTML = "";

            function createPerson(type, location) {
                const el = document.createElement("div");
                el.textContent = type === 'm' ? "üëº" : "üë∫";
                el.className = (type === 'm' ? "bg-blue-100" : "bg-red-100") +
                    " rounded-full px-2 py-1 shadow cursor-pointer text-2xl";
                el.onclick = () => movePerson(type, location);
                return el;
            }

            for (let i = 0; i < state.left.m; i++) left.appendChild(createPerson('m', 'left'));
            for (let i = 0; i < state.left.c; i++) left.appendChild(createPerson('c', 'left'));
            for (let i = 0; i < state.right.m; i++) right.appendChild(createPerson('m', 'right'));
            for (let i = 0; i < state.right.c; i++) right.appendChild(createPerson('c', 'right'));
            for (let i = 0; i < state.boat.m; i++) boat.appendChild(createPerson('m', 'boat'));
            for (let i = 0; i < state.boat.c; i++) boat.appendChild(createPerson('c', 'boat'));

            // Muestra el bote
            const icon = document.createElement("span");
            icon.textContent = "‚õµ";
            icon.className = "cursor-pointer";
            icon.onclick = moveBoat;
            boat.appendChild(icon);

            boat.style.left = state.boatSide === 'left' ? "10%" : "60%";
            boat.style.transform = state.boatSide === 'left' ? "scaleX(1)" : "scaleX(-1)";
        }

        function movePerson(type, location) {
            if (location === 'boat') {
                // bajar del bote
                if (state.boatSide === 'left') state.left[type]++;
                else state.right[type]++;
                state.boat[type]--;
            } else {
                // subir al bote
                if (state.boat.m + state.boat.c >= 2) return; // m√°x 2 en el bote
                if (state.boatSide !== location) return; // solo si est√°n en el mismo lado
                if (state[location][type] > 0) {
                    state[location][type]--;
                    state.boat[type]++;
                }
            }
            render();
        }

        function moveBoat() {
            if (state.boat.m + state.boat.c === 0) return; // no se puede mover vac√≠o

            // mover bote
            state.boatSide = state.boatSide === 'left' ? 'right' : 'left';

            // descargar personas
            if (state.boatSide === 'left') {
                state.left.m += state.boat.m;
                state.left.c += state.boat.c;
            } else {
                state.right.m += state.boat.m;
                state.right.c += state.boat.c;
            }
            state.boat.m = 0;
            state.boat.c = 0;

            if (!isValidState()) {
                stopTimer();
                alert("üíÄ ¬°Los misioneros fueron comidos! üò±");
                resetGame();
                return;
            }

            if (state.right.m === 3 && state.right.c === 3) {
                render();
                setTimeout(() => {
                    stopTimer();
                    document.getElementById("message").textContent = "üéâ ¬°Ganaste! Todos cruzaron sanos y salvos.";
                    document.getElementById("reset-btn").disabled = false;
                }, 200);
                return;
            }

            render();
        }

        function isValidState() {
            const { left, right } = state;
            const lValid = (left.m === 0 || left.m >= left.c);
            const rValid = (right.m === 0 || right.m >= right.c);
            return lValid && rValid;
        }

        function resetGame() {
            state = {
                left: { m: 3, c: 3 },
                right: { m: 0, c: 0 },
                boat: { m: 0, c: 0 },
                boatSide: 'left'
            };
            document.getElementById("message").textContent = "";
            document.getElementById("reset-btn").disabled = true;
            stopTimer();
            startTimer();
            render();
        }

        function startAuto() {
            const mode = document.getElementById("auto-mode").value;
            resetGame();

            if (mode === 'safe') {
                let i = 0;
                const interval = setInterval(() => {
                    if (i >= safePath.length) {
                        clearInterval(interval);
                        document.getElementById("message").textContent = "üéâ ¬°Ganaste en modo seguro!";
                        document.getElementById("reset-btn").disabled = false;
                        stopTimer();
                        return;
                    }
                    const step = safePath[i];
                    const [leftM, leftC] = step.left.split(',').map(v => parseInt(v));
                    const [rightM, rightC] = step.right.split(',').map(v => parseInt(v));
                    const boatSide = step.boat;

                    // Calcular qu√© hay en el bote
                    const boatM = 3 - leftM - rightM;
                    const boatC = 3 - leftC - rightC;

                    state = {
                        left: { m: leftM, c: leftC },
                        right: { m: rightM, c: rightC },
                        boat: { m: boatM, c: boatC },
                        boatSide: boatSide
                    };

                    render();
                    i++;
                }, 1000);
            } else {
                window.location.href = "/random";
            }
        }

        window.onload = () => {
            render();
            startTimer();
        }
    </script>

</head>

<body class="bg-blue-100 min-h-screen flex flex-col items-center p-6">

    <h1 class="text-3xl font-bold text-center mb-6">üåä Misioneros y Can√≠bales</h1>

    <div id="timer" class="text-xl font-semibold mb-2">‚è±Ô∏è Tiempo: 00:00</div>

    <div id="message" class="mb-3 text-lg font-bold text-green-700"></div>

    <div
        class="flex items-center justify-center w-full max-w-5xl h-40 rounded-lg shadow-lg overflow-hidden border border-gray-300">
        <!-- Orilla izquierda -->
        <div id="left" class="w-1/3 h-full bg-green-200 flex justify-end items-center p-4 gap-1 flex-wrap text-2xl">
            <!-- personajes renderizados desde JS -->
        </div>

        <!-- R√≠o -->
        <div class="w-1/3 h-full bg-blue-300 flex items-center justify-center relative">
            <div id="boat" class="absolute transition-all duration-500 text-4xl cursor-pointer flex gap-1 items-center">
                <!-- personajes en el bote + √≠cono -->
                <span>‚õµ</span>
            </div>
        </div>

        <!-- Orilla derecha -->
        <div id="right" class="w-1/3 h-full bg-green-200 flex justify-start items-center p-4 gap-1 flex-wrap text-2xl">
            <!-- personajes renderizados desde JS -->
        </div>
    </div>

    <div class="flex space-x-4 mt-6 items-center">
        <label for="auto-mode" class="text-lg font-semibold">Modo:</label>
        <select id="auto-mode" class="px-2 py-1 rounded bg-white text-black">
            <option value="safe">Seguro</option>
            <option value="random">Aleatorio</option>
        </select>
        <button onclick="startAuto()" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded">
            ü§ñ Autom√°tico
        </button>

        <button id="reset-btn" onclick="resetGame()"
            class="px-4 py-2 bg-blue-500 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            üîÅ Reiniciar Juego
        </button>
    </div>

</body>

</html>